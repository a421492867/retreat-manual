# Redis持久化

*redis提供两种不同持久化方法来将数据存储到硬盘*

> 1.快照 可以将存在于某一时刻的所有数据都写入硬盘里
>
> 2.只追加文件 AOF  在执行写命令时 将被执行的写命令复制到硬盘里

## 快照持久化

*Redis可以通过创建快照来获得存储在内存里面的数据在某个时间点上的副本 在创建快照之后 用户可以对快照进行备份 可以将快照复制到其他服务器从而创建具有相同数据的服务器副本 还可以将快照留在原地以便重启服务器时使用*

```shell
save 60 1000
stop-writes-on-bgsave-error no
rdbcompression yes
dbfilename dump.rdb
```

*根据配置 快照将被写入dbfilename选项指定的文件里面 并存储在dir选项指定的路径上面*

**如果在新的快照文件创建完毕之前 redis、系统或者硬件三者之一崩溃 那么redis将丢失最近一次创建快照之后写入的所有数据**



## AOF持久化

*AOF持久化会将被执行的写命令写到一个AOF文件的末尾，以此来记录数据发生的变化。因此 redis只要从头到尾重新执行一次AOF文件包含的所有写命令 就可以恢复AOF文件所记录的数据集*

```shell
appendonly no
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

## Redis复制的启动过程

| 步骤 | 主服务器操作                                                 | 从服务器操作                                                 |
| :--- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1    | 等待命令进入                                                 | 连接(或重新连接)主服务器 发送SYNC命令                        |
| 2    | 开始执行BGSAVE 并使用缓冲区记录BGSAVE之后执行的所有写命令    | 根据配置项来决定是继续使用现有数据(如果有的话)来处理客户端命令请求 还是向发送请求的客户端返回错误 |
| 3    | BGSAVE执行完毕 向从服务器发送快照文件 并在发送期间继续使用缓冲区记录被执行的写命令 | 丢弃所有旧数据(如果有的话) 开始载入主服务器发来的快照文件    |
| 4    | 快照文件发送完毕 开始向从服务器发送存储在缓冲区里边的写命令  | 完成对快照文件的解释操作 像往常一样开始接受命令请求          |
| 5    | 缓冲区存储的写命令发送完毕 从现在开始 每执行一个写命令 就向从服务器发送相同的写命令 | 执行主服务器发来的所有存储在缓冲区里边的写命令 并从现在开始 接收并执行主服务器传来的每个写命令 |

*如果通过配置SLAVEOF来设置为从服务器 那么redis启动时首先会载入当前可用的任何快照文件或AOF文件 然后连接主服务器并执行上表操作  如果使用的是SLAVEOF命令 那么redis立即尝试连接主服务器 并在连接成功后 执行上表的复制过程*

**redis不支持主主复制**

